<?php
// ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®é–‹å§‹
session_start();

// ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰ã‚’ã‚ªãƒ³
$debug_mode = true;
if (!isset($_SESSION['username']) || !isset($_SESSION['user_id'])) {
    if ($debug_mode) {
        echo "<p style='color:red;'>ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒå­˜åœ¨ã—ã¾ã›ã‚“ã€‚</p>";
        echo "<p>ãƒ‡ãƒãƒƒã‚°æƒ…å ±:</p>";
        echo "<pre>SESSION: " . print_r($_SESSION, true) . "</pre>";
    }
    exit;
}

// ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‹ã‚‰å€¤ã‚’å–å¾—
$username = $_SESSION['username'];
$user_id = $_SESSION['user_id'];

// ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«æ¥ç¶šã™ã‚‹ã‚³ãƒ¼ãƒ‰ãŒå…¥ã£ãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¤ãƒ³ã‚¯ãƒ«ãƒ¼ãƒ‰
require 'db.php';

// ã‚¹ãƒ†ãƒƒãƒ—ã‚’å–å¾—
$step = isset($_POST['step']) ? intval($_POST['step']) : 1;

// æˆ»ã‚‹ãƒœã‚¿ãƒ³ãŒæŠ¼ã•ã‚ŒãŸå ´åˆã®å‡¦ç†
if (isset($_POST['back'])) {
    $step--; // 1ã¤å‰ã«æˆ»ã‚‹ãŸã‚ã€1ã ã‘æ¸›ã‚‰ã™
} else if (isset($_POST['next'])) {
    $step++; // æ¬¡ã¸é€²ã‚€ãŸã‚ã€1ã ã‘å¢—ã‚„ã™
}

// å¤‰æ•°ã®åˆæœŸåŒ–
$medication_name = '';
$administration_time = '';

try {
    if ($step == 1) { //ã“ã®æ®µéšã§ã¯æœç”¨ã™ã‚‹è–¬ã‚’é¸ã¶
        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒä½¿ã£ã¦ã„ã‚‹è–¬åã‚’å–å¾—
        $stmt = $pdo->prepare("SELECT DISTINCT medication_name FROM medication_schedule WHERE user_id = :user_id");
        $stmt->bindParam(':user_id', $user_id);
        $stmt->execute();
        $medications = $stmt->fetchAll(PDO::FETCH_ASSOC);
    } elseif ($step == 2 && isset($_POST['medication_name'])) { //ã“ã®æ®µéšã§ã¯æœç”¨ã™ã‚‹è–¬ã®æ™‚é–“å¸¯ã‚’é¸ã¶
        // é¸æŠã•ã‚ŒãŸè–¬ã®æœç”¨æ™‚é–“ã‚’å–å¾—
        $medication_name = $_POST['medication_name'];
        //æœç”¨æ™‚é–“ãŒæ—©ã„é †
        $stmt = $pdo->prepare("SELECT administration_time FROM medication_schedule WHERE user_id = :user_id AND medication_name = :medication_name ORDER BY administration_time");
        $stmt->bindParam(':user_id', $user_id);
        $stmt->bindParam(':medication_name', $medication_name);
        $stmt->execute();
        $administration_times = $stmt->fetchAll(PDO::FETCH_ASSOC);
    } elseif ($step == 3 && isset($_POST['medication_name']) && isset($_POST['administration_time'])) {  //ã“ã®æ®µéšã§ã¯æœç”¨æ—¥ã‚’é¸ã¶
        // é¸æŠã•ã‚ŒãŸè–¬ã¨æœç”¨æ™‚é–“ã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’å–å¾—
        $medication_name = $_POST['medication_name'];
        $administration_time = $_POST['administration_time'];
        $stmt = $pdo->prepare("SELECT start_date, end_date FROM medication_schedule WHERE user_id = :user_id AND medication_name = :medication_name AND administration_time = :administration_time");
        $stmt->bindParam(':user_id', $user_id);
        $stmt->bindParam(':medication_name', $medication_name);
        $stmt->bindParam(':administration_time', $administration_time);
        $stmt->execute();
        $schedule = $stmt->fetch(PDO::FETCH_ASSOC);

        // æ—¢å­˜ã®æœç”¨è¨˜éŒ²ãŒã‚ã‚‹ã‹ç¢ºèª
        //ã¾ãšã€POSTãƒ¡ã‚½ãƒƒãƒ‰ã§ã‹ã¤é€ã‚‰ã‚Œã¦ããŸå†…å®¹ãŒã‚ã‚‹
        if ($_SERVER['REQUEST_METHOD'] == 'POST' && isset($_POST['administration_date'])) {
            //é€ã‚‰ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã‚’å…¥æ‰‹
            $selected_date = $_POST['administration_date'];

            //é€ã‚‰ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ãŒæœç”¨æœŸé–“å†…ã§ã‚ã‚‹å ´åˆ
            if ($selected_date >= $schedule['start_date'] && $selected_date <= $schedule['end_date']) {
                try {
                    //ã•ã‚‰ã«ã€ãã®è¨˜éŒ²ãŒæ—¢ã«ãªã„ã‹ã‚’ç¢ºèªã™ã‚‹
                    $check_stmt = $pdo->prepare("SELECT COUNT(*) FROM medication_record 
                        WHERE user_id = :user_id AND drug_id = 
                        (SELECT drug_id FROM medication_schedule WHERE user_id = :user_id AND medication_name = :medication_name AND administration_time = :administration_time)
                        AND administration_date = :administration_date");
                    $check_stmt->bindParam(':user_id', $user_id);
                    $check_stmt->bindParam(':medication_name', $medication_name);
                    $check_stmt->bindParam(':administration_time', $administration_time);
                    $check_stmt->bindParam(':administration_date', $selected_date);
                    $check_stmt->execute();
                    //ã“ã“ã§è¨˜éŒ²ã•ã‚Œã¦ã„ã‚‹ã‹ã©ã†ã‹ã®çµæœã‚’å…¥æ‰‹
                    $record_exists = $check_stmt->fetchColumn();

                    //ã‚‚ã—ãã®æ—¥ã«æ—¢ã«ãƒ¬ã‚³ãƒ¼ãƒ‰ãŒã‚ã‚‹å ´åˆ
                    if ($record_exists) {
                        $record_message = "<p style='color: red;'>{$selected_date}ã®æœç”¨è¨˜éŒ²ã¯æ—¢ã«è¡Œã£ã¦ã„ã¾ã™ã€‚</p>";
                    } else {
                        //è¨˜éŒ²ã‚’ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«æ›¸ãè¾¼ã‚€
                        $stmt = $pdo->prepare("INSERT INTO medication_record (user_id, drug_id, administration_date)
                            VALUES (:user_id, 
                            (SELECT drug_id FROM medication_schedule 
                            WHERE user_id = :user_id AND medication_name = :medication_name AND administration_time = :administration_time), 
                            :administration_date)");
                        $stmt->bindParam(':user_id', $user_id);
                        $stmt->bindParam(':medication_name', $medication_name);
                        $stmt->bindParam(':administration_time', $administration_time);
                        $stmt->bindParam(':administration_date', $selected_date);
                        $stmt->execute();
                        $record_message = "<p>æœç”¨è¨˜éŒ²ãŒæ­£å¸¸ã«ä¿å­˜ã•ã‚Œã¾ã—ãŸã€‚</p>";
                        $record_details = htmlspecialchars($medication_name) . "ã€€âŒš" . htmlspecialchars($administration_time) ."  ğŸ“…" . htmlspecialchars($selected_date);
                        // $record_details = "<p>è¨˜éŒ²å†…å®¹:</p>
                        //     <ul>
                        //         <li>è–¬å: " . htmlspecialchars($medication_name) . "</li>
                        //         <li>æœç”¨æ™‚é–“: " . htmlspecialchars($administration_time) . "</li>
                        //         <li>æœç”¨æ—¥ä»˜: " . htmlspecialchars($selected_date) . "</li>
                        //     </ul>";
                    }
                } catch (PDOException $e) {
                    $record_message = "<p style='color: red;'>ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼: " . $e->getMessage() . "</p>";
                }
            } else {
                $record_message = "<p style='color: red;'>é¸æŠã•ã‚ŒãŸæ—¥ä»˜ã¯æœç”¨æœŸé–“å¤–ã§ã™ã€‚ã‚‚ã†ä¸€åº¦ã‚„ã‚Šç›´ã—ã¦ãã ã•ã„ã€‚</p>";
            }
        }
    }
} catch (PDOException $e) {
    die("ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼: " . $e->getMessage());
}
?>

<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css" type="text/css">
    <title>è–¬ã®æœç”¨è¨˜éŒ²</title>
</head>


<body>

    <form action="logout.php" method="post">
        <button class="logout-button" type="submit">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
    </form>

    <form action="deleteMedicine.php" method="get">
        <button class="delete-button" type="submit">è–¬ã‚’å‰Šé™¤</button>
    </form>

    <div class="container">

        <div class="header">
            <h2>è–¬ã®æœç”¨è¨˜éŒ²</h2>
            <?php if (isset($record_message)) {
                echo $record_message;
                if (isset($record_details)) {
                    echo $record_details;
                }
            } ?>
        </div>


        <div class="button-container">
            <form action="home.php" method="get">
                <button class="home-button" type="submit">ãƒ›ãƒ¼ãƒ ç”»é¢ã¸</button>
            </form>


            <form action="list.php" method="get">
                <button type="submit">è–¬ãƒªã‚¹ãƒˆ</button>
            </form>

            <form action="add.php" method="get">
                <button type="submit">è–¬ã‚’æ–°è¦ç™»éŒ²</button>
            </form>
        </div>

        <div class="divider"></div>

        <?php if ($step == 1): ?>
            <div class="form-container">
                <form method="post" action="">
                    <label for="medication_name">è–¬ã‚’é¸æŠ:</label>
                    <select name="medication_name" id="medication_name" required>
                        <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                        <?php foreach ($medications as $medication): ?>
                            <option value="<?php echo htmlspecialchars($medication['medication_name']); ?>">
                                <?php echo htmlspecialchars($medication['medication_name']); ?>
                            </option>
                        <?php endforeach; ?>
                    </select>
                    <input type="hidden" name="step" value="1">
                    <button type="submit" name="next" value="true">æ¬¡ã¸</button>
                </form>
            </div>
        <?php elseif ($step == 2): ?>
            <div class="form-container">
                <form method="post" action="">
                    <label for="administration_time">æœç”¨æ™‚é–“ã‚’é¸æŠ:</label>
                    <select name="administration_time" id="administration_time">
                        <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                        <?php foreach ($administration_times as $time): ?>
                            <option value="<?php echo htmlspecialchars($time['administration_time']); ?>">
                                <?php echo htmlspecialchars($time['administration_time']); ?>
                            </option>
                        <?php endforeach; ?>
                    </select>
                    <input type="hidden" name="medication_name" value="<?php echo htmlspecialchars($medication_name); ?>">
                    <input type="hidden" name="step" value="2">
                    <button type="submit" name="next" value="true">æ¬¡ã¸</button>
                    <button type="submit" name="back" value="true">æˆ»ã‚‹</button>
                    <p>è–¬å: <?php echo htmlspecialchars($medication_name); ?></p>
                </form>
            </div>
        <?php elseif ($step == 3): ?>
            <div class="form-container">
                <form method="post" action="">
                    <label for="administration_date">æœç”¨æ—¥ä»˜ã‚’é¸æŠ:</label>
                    <input type="date" id="administration_date" name="administration_date">
                    <input type="hidden" name="medication_name" value="<?php echo htmlspecialchars($medication_name); ?>">
                    <input type="hidden" name="administration_time"
                        value="<?php echo htmlspecialchars($administration_time); ?>">
                    <input type="hidden" name="step" value="3">
                    <button type="submit">è¨˜éŒ²</button>
                    <button type="submit" name="back" value="true">æˆ»ã‚‹</button>
                    <p>è–¬å: <?php echo htmlspecialchars($medication_name); ?></p>
                    <p>æœç”¨æ™‚é–“: <?php echo htmlspecialchars($administration_time); ?></p>
                    <p>æœç”¨é–‹å§‹æ—¥: <?php echo htmlspecialchars($schedule['start_date']); ?></p>
                    <p>æœç”¨çµ‚äº†æ—¥: <?php echo htmlspecialchars($schedule['end_date']); ?></p>
                </form>
            </div>
        <?php endif; ?>

    </div>
</body>

</html>